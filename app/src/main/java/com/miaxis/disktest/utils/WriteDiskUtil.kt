package com.miaxis.disktest.utils

import android.content.Context
import java.util.concurrent.TimeUnit
import java.util.concurrent.locks.ReentrantLock
import kotlin.concurrent.withLock

class WriteDiskUtil {

    private var sendFlag = true

    private var mSendThread: SendThread? = null

    private var context: Context? = null

    private var time = ""

    private val sendLock = ReentrantLock()
    private val sendCondition = sendLock.newCondition()

    companion object {
        private const val MSG = "start 111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222" + "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" +
                "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222 end"

        val instance: WriteDiskUtil by lazy(mode = LazyThreadSafetyMode.SYNCHRONIZED) {
            WriteDiskUtil()
        }
    }

    init {
        mSendThread = SendThread()
        mSendThread!!.start()
    }

    public fun init(context: Context){
        this.context = context
    }

    private inner class SendThread : Thread() {
        override fun run() {
            super.run()
            while (!isInterrupted) {
                while (sendFlag) {
                    if (context != null) {
                        val timeTemp = TimeUtil.nowTimeOfMinute()
                        if (timeTemp != time) {
                            time = timeTemp
                            LogUtil.instance.init(context!!)
                        }
                        LogUtil.instance.d(msg = time + MSG, recordLocal = true)
                    } else {
                        sendLock.withLock {
                            sendCondition.await(1, TimeUnit.SECONDS)
                        }
                    }
                }
            }
        }
    }

}